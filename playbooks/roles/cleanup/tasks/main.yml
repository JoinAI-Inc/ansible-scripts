- name: Safety checks
  assert:
    that:
      - cleanup_dir is string
      - cleanup_dir | length > 1
      - cleanup_dir.startswith('/')
      - (not cleanup_deny_root) or (cleanup_dir != '/')
    fail_msg: "Refuse to cleanup unsafe path: {{ cleanup_dir }}"

- name: Ensure cleanup dir exists (optional)
  stat:
    path: "{{ cleanup_dir }}"
  register: cleanup_dir_stat

- name: Skip if cleanup dir does not exist
  debug:
    msg: "Skip cleanup because dir does not exist: {{ cleanup_dir }}"
  when: not cleanup_dir_stat.stat.exists

- name: Find old items
  find:
    paths: "{{ cleanup_dir }}"
    age: "{{ cleanup_age }}"
    recurse: true
    file_type: "{{ cleanup_file_type }}"
  register: cleanup_found
  when: cleanup_dir_stat.stat.exists

- name: Remove old items
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ cleanup_found.files }}"
  when:
    - cleanup_dir_stat.stat.exists
    - cleanup_found.matched | default(0) | int > 0

# 可选：仅在“只删文件”时，额外清理空目录（避免目录结构越积越深）
- name: Find empty directories (after file cleanup)
  find:
    paths: "{{ cleanup_dir }}"
    recurse: true
    file_type: directory
    # 注意：这里 age 不限制，只删空目录
  register: cleanup_dirs
  when:
    - cleanup_dir_stat.stat.exists
    - cleanup_remove_empty_dirs | bool
    - cleanup_file_type == 'file'

- name: Remove empty directories
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ cleanup_dirs.files | sort(attribute='path', reverse=true) }}"
  when:
    - cleanup_dir_stat.stat.exists
    - cleanup_remove_empty_dirs | bool
    - cleanup_file_type == 'file'
    - (item.path != cleanup_dir)  # 不删顶层目录本身
