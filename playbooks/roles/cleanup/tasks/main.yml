- name: Safety checks
  assert:
      that:
          - cleanup_dirs is iterable
          - cleanup_dirs | length > 0
          - item.startswith('/')
          - (not cleanup_deny_root) or (item != '/')
      fail_msg: "Refuse to cleanup unsafe path: {{ item }}"
  loop: "{{ cleanup_dirs }}"

- name: Check cleanup dir exists
  stat:
      path: "{{ item }}"
  register: cleanup_dir_stats
  loop: "{{ cleanup_dirs }}"

- name: Find old files
  find:
      paths: "{{ item.stat.path }}"
      age: "{{ cleanup_age }}"
      recurse: true
      file_type: "{{ cleanup_file_type }}"
  register: cleanup_found
  when: item.stat.exists
  loop: "{{ cleanup_dir_stats.results }}"

- name: Remove old files
  file:
      path: "{{ item.1.path }}"
      state: absent
  loop: "{{ cleanup_found.results | subelements('files') }}"
  when: cleanup_found is defined
